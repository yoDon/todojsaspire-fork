name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download dotnet-install script
        run: |
          curl -fsSL https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
          chmod +x dotnet-install.sh

      - name: Install latest .NET SDK (expect 10.x)
        run: |
          set -e
          mkdir -p "$RUNNER_TEMP/dotnet"
          ./dotnet-install.sh --channel 10.0 --quality ga --install-dir "$RUNNER_TEMP/dotnet" || ./dotnet-install.sh --channel LTS --install-dir "$RUNNER_TEMP/dotnet"
          echo "DOTNET_ROOT=$RUNNER_TEMP/dotnet" >> $GITHUB_ENV
          echo "DOTNET_INSTALL_DIR=$RUNNER_TEMP/dotnet" >> $GITHUB_ENV
          echo "$RUNNER_TEMP/dotnet:$RUNNER_TEMP/dotnet/tools" >> $GITHUB_PATH
          "$RUNNER_TEMP/dotnet/dotnet" --version
          if ! "$RUNNER_TEMP/dotnet/dotnet" --version | grep -q '^10\.'; then echo 'Expected .NET 10 SDK but got:'; "$RUNNER_TEMP/dotnet/dotnet" --version; exit 1; fi

      - name: Display dotnet info
        run: dotnet --info

      - name: Install Aspire CLI
        run: |
          curl -sSL https://aspire.dev/install.sh -o aspire-install.sh
          chmod +x aspire-install.sh
          ./aspire-install.sh
          echo "$HOME/.aspire/bin" >> $GITHUB_PATH
          if [ ! -f "$HOME/.aspire/bin/aspire" ]; then echo 'Aspire CLI not found after install'; ls -R "$HOME/.aspire" || true; exit 1; fi
          "$HOME/.aspire/bin/aspire" --version

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore solution
        run: dotnet restore src/TodojsAspire.sln

      - name: Build solution (Release)
        run: dotnet build src/TodojsAspire.sln --configuration Release --no-restore

      - name: Aspire build (container images)
        run: |
          set -e
          "$HOME/.aspire/bin/aspire" do build --verbose || "$HOME/.aspire/bin/aspire" build --verbose || true
          echo "Listing docker images after Aspire build"
          docker images | head -n 40

      - name: Login to GHCR
        if: ${{ github.ref == 'refs/heads/publish' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and push apiservice image to GHCR
        if: ${{ github.ref == 'refs/heads/publish' }}
        run: |
          set -e
          IMAGE_NAME=apiservice
          IMAGE_TAG=$(docker images --format '{{.Repository}}:{{.Tag}}' | awk -F: -v name="$IMAGE_NAME" '$1==name {print $2; exit}')
          if [ -z "$IMAGE_TAG" ]; then
            if docker images "$IMAGE_NAME" --format '{{.Tag}}' | grep -q '^latest$'; then
              IMAGE_TAG=latest
            fi
          fi
          if [ -z "$IMAGE_TAG" ]; then
            echo "Could not find local image '$IMAGE_NAME' built by Aspire. Listing images for diagnostics:";
            docker images | head -n50
            exit 1
          fi
          SOURCE_REF="$IMAGE_NAME:$IMAGE_TAG"
          TARGET_REPO="ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME"
          TARGET_REF="$TARGET_REPO:$IMAGE_TAG"
          echo "Tagging $SOURCE_REF as $TARGET_REF"
          docker tag "$SOURCE_REF" "$TARGET_REF"
          docker push "$TARGET_REF"
          if [ "$IMAGE_TAG" != "latest" ]; then
            docker tag "$SOURCE_REF" "$TARGET_REPO:latest"
            docker push "$TARGET_REPO:latest"
          fi
          echo "Pushed image(s): $TARGET_REF and (possibly) $TARGET_REPO:latest"
